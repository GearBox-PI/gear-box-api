openapi: 3.1.0
info:
  title: Gear Box API
  version: 1.0.0
  description: |
    API de oficina mecânica. Faça login para obter o token e use Bearer nas rotas protegidas.
    - Login: POST /login
    - Logout: DELETE /logout
servers:
  - url: https://gearbox.example.com

tags:
  - name: Auth
    description: Autenticação da API
  - name: Users
  - name: Clients
  - name: Cars
  - name: Services
  - name: Budgets
    description: Fluxo de orçamentos

paths:
  /login:
    post:
      tags: [Auth]
      summary: Login
      description: "Retorna usuário autenticado e token de acesso (Bearer). Também envia o header 'Authorization: Bearer <token>' na resposta."
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginInput'
            examples:
              dono:
                value:
                  email: dono@gearbox.com
                  password: senha123
      responses:
        '200':
          description: Autenticado
          headers:
            Authorization:
              description: Token Bearer para uso imediato
              schema:
                type: string
                example: Bearer <token>
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '400':
          description: Credenciais inválidas
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          description: Payload inválido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /logout:
    delete:
      tags: [Auth]
      summary: Logout
      description: Revoga todos os tokens do usuário autenticado e retorna 204.
      security:
        - bearerAuth: []
      responses:
        '204':
          description: No Content
        '401':
          description: Não autenticado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /users:
    get:
      tags: [Users]
      summary: Listar usuários (apenas dono)
      description: Apenas usuários com papel "dono" podem listar usuários.
      x-required-role: dono
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Lista paginada de usuários
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaginatedUsers'
        '401':
          description: Não autenticado
        '403':
          description: Sem permissão
    post:
      tags: [Users]
      summary: Criar usuário (apenas dono)
      x-required-role: dono
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserCreateInput'
      responses:
        '201':
          description: Criado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401': { description: Não autenticado }
        '403': { description: Sem permissão }

  /users/{id}:
    parameters:
      - in: path
        name: id
        required: true
        schema:
          type: string
          format: uuid
    get:
      tags: [Users]
      summary: Detalhar usuário
      description: Dono pode ver qualquer; mecânico apenas o próprio.
      security:
        - bearerAuth: []
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401': { description: Não autenticado }
        '403': { description: Sem permissão }
        '404': { description: Não encontrado }
    put:
      tags: [Users]
      summary: Atualizar usuário
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserUpdateInput'
      responses:
        '200': { description: OK }
        '401': { description: Não autenticado }
        '403': { description: Sem permissão }
        '404': { description: Não encontrado }
    patch:
      tags: [Users]
      summary: Atualizar usuário (parcial)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserUpdateInput'
      responses:
        '200': { description: OK }
        '401': { description: Não autenticado }
        '403': { description: Sem permissão }
        '404': { description: Não encontrado }
    delete:
      tags: [Users]
      summary: Remover usuário (apenas dono)
      x-required-role: dono
      security:
        - bearerAuth: []
      responses:
        '204': { description: No Content }
        '401': { description: Não autenticado }
        '403': { description: Sem permissão }
        '404': { description: Não encontrado }

  /clients:
    get:
      tags: [Clients]
      summary: Listar clientes
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Lista paginada de clientes
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaginatedClients'
    post:
      tags: [Clients]
      summary: Criar cliente
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ClientCreateInput'
      responses:
        '201':
          description: Criado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Client'

  /clients/{id}:
    parameters:
      - in: path
        name: id
        required: true
        schema:
          type: string
          format: uuid
    get:
      tags: [Clients]
      summary: Detalhar cliente
      security:
        - bearerAuth: []
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Client'
        '404': { description: Não encontrado }
    put:
      tags: [Clients]
      summary: Atualizar cliente
      x-required-role: dono
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ClientUpdateInput'
      responses:
        '200': { description: OK }
        '404': { description: Não encontrado }
    patch:
      tags: [Clients]
      summary: Atualizar cliente (parcial)
      x-required-role: dono
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ClientUpdateInput'
      responses:
        '200': { description: OK }
        '404': { description: Não encontrado }
    delete:
      tags: [Clients]
      summary: Remover cliente
      x-required-role: dono
      security:
        - bearerAuth: []
      responses:
        '204': { description: No Content }
        '404': { description: Não encontrado }

  /cars:
    get:
      tags: [Cars]
      summary: Listar carros
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Lista paginada de carros
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaginatedCars'
    post:
      tags: [Cars]
      summary: Criar carro
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CarCreateInput'
      responses:
        '201':
          description: Criado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Car'

  /cars/{id}:
    parameters:
      - in: path
        name: id
        required: true
        schema:
          type: string
          format: uuid
    get:
      tags: [Cars]
      summary: Detalhar carro
      security:
        - bearerAuth: []
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Car'
        '404': { description: Não encontrado }
    put:
      tags: [Cars]
      summary: Atualizar carro
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CarUpdateInput'
      responses:
        '200': { description: OK }
        '404': { description: Não encontrado }
    patch:
      tags: [Cars]
      summary: Atualizar carro (parcial)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CarUpdateInput'
      responses:
        '200': { description: OK }
        '404': { description: Não encontrado }
    delete:
      tags: [Cars]
      summary: Remover carro
      security:
        - bearerAuth: []
      responses:
        '204': { description: No Content }
        '404': { description: Não encontrado }

  /services:
    get:
      tags: [Services]
      summary: Listar serviços
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: page
          schema:
            type: integer
            minimum: 1
            default: 1
        - in: query
          name: perPage
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 10
        - in: query
          name: startDate
          description: Data inicial (ISO 8601) para filtrar pela data de criação
          schema:
            type: string
            format: date
        - in: query
          name: endDate
          description: Data final (ISO 8601) para filtrar pela data de criação
          schema:
            type: string
            format: date
      responses:
        '200':
          description: Lista paginada de serviços
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaginatedServices'
    post:
      tags: [Services]
      summary: Criar serviço
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ServiceCreateInput'
      responses:
        '201':
          description: Criado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Service'

  /services/{id}:
    parameters:
      - in: path
        name: id
        required: true
        schema:
          type: string
          format: uuid
    get:
      tags: [Services]
      summary: Detalhar serviço
      security:
        - bearerAuth: []
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Service'
        '404': { description: Não encontrado }
    put:
      tags: [Services]
      summary: Atualizar serviço
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ServiceUpdateInput'
      responses:
        '200': { description: OK }
        '404': { description: Não encontrado }
    patch:
      tags: [Services]
      summary: Atualizar serviço (parcial)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ServiceUpdateInput'
      responses:
        '200': { description: OK }
        '404': { description: Não encontrado }
    delete:
      tags: [Services]
      summary: Remover serviço
      security:
        - bearerAuth: []
      responses:
        '204': { description: No Content }
        '404': { description: Não encontrado }

  /budgets/{id}/accept:
    parameters:
      - in: path
        name: id
        required: true
        schema:
          type: string
          format: uuid
    post:
      tags: [Budgets]
      summary: Aprovar orçamento e gerar serviço
      description: Só administradores podem aceitar um orçamento e delegar um responsável ativo.
      x-required-role: dono
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BudgetAcceptInput'
      responses:
        '200':
          description: Orçamento aceito e serviço criado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BudgetAcceptResponse'
        '401': { description: Não autenticado }
        '403': { description: Sem permissão }
        '404': { description: Orçamento não encontrado }
        '422':
          description: Usuário delegado inválido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: Bearer

  schemas:
    ErrorItem:
      type: object
      properties:
        message:
          type: string
        field:
          type: string
          nullable: true
      additionalProperties: false
    ErrorResponse:
      type: object
      properties:
        errors:
          type: array
          items:
            $ref: '#/components/schemas/ErrorItem'
      required: [errors]

    LoginInput:
      type: object
      properties:
        email: { type: string, format: email }
        password: { type: string }
      required: [email, password]

    Token:
      type: object
      properties:
        type: { type: string, example: auth_token }
        value: { type: string }
        abilities:
          type: array
          items: { type: string }
        expiresAt:
          nullable: true
          oneOf:
            - type: string
              format: date-time
            - type: 'null'
      required: [type, value, abilities]

    User:
      type: object
      properties:
        id: { type: string, format: uuid }
        nome: { type: string }
        email: { type: string, format: email }
        tipo: { type: string, enum: [dono, mecanico] }
      required: [id, nome, email, tipo]

    UserCreateInput:
      type: object
      properties:
        nome: { type: string }
        email: { type: string, format: email }
        senha: { type: string }
        tipo: { type: string, enum: [dono, mecanico] }
      required: [nome, email, senha, tipo]

    UserUpdateInput:
      type: object
      properties:
        nome: { type: string }
        senha: { type: string }
        tipo: { type: string, enum: [dono, mecanico] }

    Client:
      type: object
      properties:
        id: { type: string, format: uuid }
        nome: { type: string }
        email: { type: string, format: email, nullable: true }
        telefone: { type: string }
      required: [id, nome, telefone]

    ClientCreateInput:
      type: object
      properties:
        nome: { type: string }
        email: { type: string, format: email, nullable: true }
        telefone: { type: string }
      required: [nome, telefone]

    ClientUpdateInput:
      type: object
      properties:
        nome: { type: string }
        email: { type: string, format: email, nullable: true }
        telefone: { type: string }

    Car:
      type: object
      properties:
        id: { type: string, format: uuid }
        clientId: { type: string, format: uuid }
        marca: { type: string }
        modelo: { type: string }
        placa: { type: string }
        ano: { type: integer, minimum: 1900 }
      required: [id, clientId, marca, modelo, placa, ano]

    CarCreateInput:
      type: object
      properties:
        clientId: { type: string, format: uuid }
        marca: { type: string }
        modelo: { type: string }
        placa: { type: string }
        ano: { type: integer, minimum: 1900 }
      required: [clientId, marca, modelo, placa, ano]

    CarUpdateInput:
      type: object
      properties:
        marca: { type: string }
        modelo: { type: string }
        placa: { type: string }
        ano: { type: integer, minimum: 1900 }

    Service:
      type: object
      properties:
        id: { type: string, format: uuid }
        clientId: { type: string, format: uuid }
        carId: { type: string, format: uuid }
        status: { type: string, enum: ['Pendente', 'Em andamento', 'Concluído', 'Cancelado'] }
        description: { type: string }
        totalValue: { type: string }
        budgetId: { type: string, format: uuid, nullable: true }
        userId: { type: string, format: uuid, nullable: true }
        assignedToId: { type: string, format: uuid, nullable: true }
        createdById: { type: string, format: uuid, nullable: true }
        updatedById: { type: string, format: uuid, nullable: true }
      required: [id, clientId, carId, status, totalValue]

    ServiceCreateInput:
      type: object
      properties:
        clientId: { type: string, format: uuid }
        carId: { type: string, format: uuid }
        status: { type: string, enum: ['Pendente', 'Em andamento', 'Concluído', 'Cancelado'] }
        description: { type: string }
        totalValue: { type: number }
      required: [clientId, carId]

    ServiceUpdateInput:
      type: object
      properties:
        status: { type: string, enum: ['Pendente', 'Em andamento', 'Concluído', 'Cancelado'] }
        description: { type: string }
        totalValue: { type: number }

    Budget:
      type: object
      properties:
        id: { type: string, format: uuid }
        clientId: { type: string, format: uuid }
        carId: { type: string, format: uuid }
        userId: { type: string, format: uuid, nullable: true }
        updatedById: { type: string, format: uuid, nullable: true }
        description: { type: string }
        amount: { type: string }
        status: { type: string, enum: ['aberto', 'aceito', 'recusado', 'cancelar'] }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }
      required: [id, clientId, carId, description, amount, status, createdAt, updatedAt]

    BudgetAcceptInput:
      type: object
      properties:
        assignedToId: { type: string, format: uuid }
        confirm:
          type: boolean
          description: Confirme que deseja gerar o serviço a partir do orçamento.
          example: true
      required: [assignedToId, confirm]

    BudgetAcceptResponse:
      type: object
      properties:
        budget:
          $ref: '#/components/schemas/Budget'
        service:
          $ref: '#/components/schemas/Service'

    PaginatedUsers:
      type: object
      properties:
        meta:
          type: object
          properties:
            total: { type: integer, example: 1 }
            perPage: { type: integer, example: 10 }
            currentPage: { type: integer, example: 1 }
            lastPage: { type: integer, example: 1 }
        data:
          type: array
          items:
            $ref: '#/components/schemas/User'

    PaginatedClients:
      type: object
      properties:
        meta:
          type: object
          properties:
            total: { type: integer, example: 1 }
            perPage: { type: integer, example: 10 }
            currentPage: { type: integer, example: 1 }
            lastPage: { type: integer, example: 1 }
        data:
          type: array
          items:
            $ref: '#/components/schemas/Client'

    PaginatedCars:
      type: object
      properties:
        meta:
          type: object
          properties:
            total: { type: integer, example: 1 }
            perPage: { type: integer, example: 10 }
            currentPage: { type: integer, example: 1 }
            lastPage: { type: integer, example: 1 }
        data:
          type: array
          items:
            $ref: '#/components/schemas/Car'

    PaginatedServices:
      type: object
      properties:
        meta:
          type: object
          properties:
            total: { type: integer, example: 1 }
            perPage: { type: integer, example: 10 }
            currentPage: { type: integer, example: 1 }
            lastPage: { type: integer, example: 1 }
        data:
          type: array
          items:
            $ref: '#/components/schemas/Service'

    AuthResponse:
      type: object
      properties:
        user: { $ref: '#/components/schemas/User' }
        token: { $ref: '#/components/schemas/Token' }
      required: [user, token]
